#!/bin/bash
BASE_PATH=$(dirname $0)/..
export DATABASE_TYPE=`source $BASE_PATH/.env && echo $DATABASE_TYPE`
PROJECT_NAME=dbco-test-${DATABASE_TYPE}
DOCKER_COMPOSE="docker-compose --project-directory=$BASE_PATH -p $PROJECT_NAME --env-file .env.test -f docker-compose.main.yml -f docker-compose.test.yml -f docker-compose.${DATABASE_TYPE}.yml"

echo "=====[ SETUP ]====="
$DOCKER_COMPOSE up -d --remove-orphans

if [ -z "$1" ] || [ "$1" == "worker" ]; then
  echo
  echo "=====[ RUN TESTS FOR WORKER ]====="
  $DOCKER_COMPOSE run --rm --entrypoint=/src/vendor/bin/phpunit worker
  echo
fi

if [ -z "$1" ] || [ "$1" == "private_api" ]; then
  echo
  echo "=====[ RUN TESTS FOR PRIVATE API ]====="
  $DOCKER_COMPOSE run --rm --entrypoint=/src/vendor/bin/phpunit private_api
  echo
fi

if [ -z "$1" ] || [ "$1" == "public_api" ]; then
  echo
  echo "=====[ RUN TESTS FOR PUBLIC API ]====="
  $DOCKER_COMPOSE run --rm --entrypoint=/src/vendor/bin/phpunit public_api
  echo
fi

if [ -z "$1" ] || [ "$1" == "healthauthority_api" ]; then
  echo
  echo "=====[ RUN TESTS FOR HEALTHAUTHORITY API ]====="
  $DOCKER_COMPOSE run --rm --entrypoint=/src/vendor/bin/phpunit healthauthority_api
  echo
fi

echo
echo "=====[ CLEANUP ]====="
$DOCKER_COMPOSE down
docker volume rm "${PROJECT_NAME}_${DATABASE_TYPE}-data"
