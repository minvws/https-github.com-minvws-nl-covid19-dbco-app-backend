#!/bin/bash
BASE_PATH=$(dirname $0)/..
PROJECT_NAME=dbco-test

echo "=====[ SETUP ]====="
docker-compose --env-file ./.env.test -p $PROJECT_NAME -f docker-compose.yml -f docker-compose.test.yml up -d --remove-orphans

if [ -z "$1" ] || [ "$1" == "worker" ]; then
  echo
  echo "=====[ RUN TESTS FOR WORKER ]====="
  docker-compose --env-file ./.env.test -p $PROJECT_NAME -f docker-compose.yml -f docker-compose.test.yml run --rm --entrypoint=/src/vendor/bin/phpunit worker
  echo
fi

if [ -z "$1" ] || [ "$1" == "private_api" ]; then
  echo
  echo "=====[ RUN TESTS FOR PRIVATE API ]====="
  docker-compose --env-file ./.env.test -p $PROJECT_NAME -f docker-compose.yml -f docker-compose.test.yml run --rm --entrypoint=/src/vendor/bin/phpunit private_api
  echo
fi

if [ -z "$1" ] || [ "$1" == "public_api" ]; then
  echo
  echo "=====[ RUN TESTS FOR PUBLIC API ]====="
  docker-compose --env-file ./.env.test -p $PROJECT_NAME -f docker-compose.yml -f docker-compose.test.yml run --rm --entrypoint=/src/vendor/bin/phpunit public_api
  echo
fi

if [ -z "$1" ] || [ "$1" == "healthauthority_api" ]; then
  echo
  echo "=====[ RUN TESTS FOR HEALTHAUTHORITY API ]====="
  docker-compose --env-file ./.env.test -p $PROJECT_NAME -f docker-compose.yml -f docker-compose.test.yml run --rm --entrypoint=/src/vendor/bin/phpunit healthauthority_api
  echo
fi

echo
echo "=====[ CLEANUP ]====="
docker-compose --env-file ./.env.test -p $PROJECT_NAME -f docker-compose.yml -f docker-compose.test.yml down
docker volume rm "${PROJECT_NAME}_oracle-data"
