#!/bin/bash
BASE_PATH=$(dirname $0)/..

. $BASE_PATH/.env

echo "=====[ Start containers ]======================="
docker-compose up -d

echo
echo "=====[ Setup Oracle database ]========================="

echo "Waiting for Oracle to launch on ${ORACLE_PORT:-1521}..."
while ! echo "SELECT 1 FROM dual" | docker-compose -f $BASE_PATH/docker-compose.yml -f $BASE_PATH/docker-compose.dev.yml run --rm sqlplus > /dev/null 2>&1; do
  sleep 1
done

echo "CREATE USER healthauthority_api IDENTIFIED BY \"$HEALTHAUTHORITY_API_DB_PASSWORD\";" | docker-compose -f $BASE_PATH/docker-compose.yml -f $BASE_PATH/docker-compose.dev.yml run --rm sqlplus
echo "CREATE USER portal IDENTIFIED BY \"$PORTAL_DB_PASSWORD\";" | docker-compose -f $BASE_PATH/docker-compose.yml -f $BASE_PATH/docker-compose.dev.yml run --rm sqlplus
docker-compose -f $BASE_PATH/docker-compose.yml -f $BASE_PATH/docker-compose.dev.yml run --rm sqlplus < $BASE_PATH/install/oracle/permissions.sql

echo
echo "=====[ SETUP WORKER ]====="
docker-compose -f $BASE_PATH/docker-compose.yml -f $BASE_PATH/docker-compose.dev.yml run --rm --entrypoint composer worker install

echo
echo "=====[ SETUP PRIVATE API ]====="
docker-compose -f $BASE_PATH/docker-compose.yml -f $BASE_PATH/docker-compose.dev.yml run --rm --entrypoint composer private_api install

echo
echo "=====[ SETUP PUBLIC API ]====="
docker-compose -f $BASE_PATH/docker-compose.yml -f $BASE_PATH/docker-compose.dev.yml run --rm --entrypoint composer public_api install

echo
echo "=====[ SETUP HEALTHAUTHORITY API ]====="
docker-compose -f $BASE_PATH/docker-compose.yml -f $BASE_PATH/docker-compose.dev.yml run --rm --entrypoint composer healthauthority_api install

echo
echo "=====[ SETUP PORTAL ]====="
docker-compose -f $BASE_PATH/docker-compose.yml -f $BASE_PATH/docker-compose.dev.yml run --rm --entrypoint composer portal install
docker-compose -f $BASE_PATH/docker-compose.yml -f $BASE_PATH/docker-compose.dev.yml run --rm --entrypoint php artisan migrate
